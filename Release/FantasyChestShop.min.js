"use strict";var ILAPI_PosGetLand,ILAPI_GetOwer,plugins;mc.listen("onServerStarted",()=>{(plugins=lxl.listPlugins()).forEach(e=>{"iland-core.lua"==e&&(Land=!0)});let e=lxl.import("ILAPI_GetVersion");ILAPI_PosGetLand=lxl.import("ILAPI_PosGetLand"),ILAPI_GetOwer=lxl.import("ILAPI_GetOwner"),setTimeout(()=>{try{e()}catch(e){Land=!1}},200),setTimeout(()=>{init(),updateShopList()},200)});var Config,DEBUG=!1,Land=!1,Version="1.2.5",Dir="./Plugins/PlayerShop/",ShopPosList=new Array;function init(){logger.setConsole(!0),logger.setFile("./logs/FantasyChestShop.txt"),logger.setTitle("FantasyChestShop"),log("[FantasyChestShop] ========================="),log("[FantasyChestShop] FantasyChestShop v"+Version),log("[FantasyChestShop] Plugin loaded"),log("[FantasyChestShop] 作者：PeterXiong720"),Land&&log("[FantasyChestShop] 已检测到iland，已开启领地检查功能"),file.exists(Dir)||file.mkdir(Dir),file.exists(Dir+"Config.json")?(Config=new Configuration(JSON.parse(file.readFrom(Dir+"Config.json"))),log("[FantasyChestShop] 已加载配置文件："+Dir+"Config.json")):(log("[FantasyChestShop] 未找到配置文件，正在创建..."),Config=new Configuration,DataHelper.SaveData(),log("[FantasyChestShop] 已创建配置文件："+Dir+"Config.json")),log("[FantasyChestShop] =========================")}function updateShopList(){ShopPosList=new Array,Config.ShopData.forEach(e=>{null!=e&&(e=mc.newIntPos(e.Pos.x,e.Pos.y,e.Pos.z,e.Pos.dimid),ShopPosList.push(e))})}function RemoveShop(a){var o={x:a.x,y:a.y,z:a.z,dimid:a.dimid};for(let e=0;e<Config.ShopData.length;e++){var t=Config.ShopData[e];if(null!=t&&JSON.stringify(t.Pos)==JSON.stringify(o))return function(e){let o=Config.ShopKeepers.get(e.Shopkeeper);if(null!=o){var t=a.x+" "+a.y+" "+a.z+" "+a.dimid;for(let e=0;e<o.length;e++)t==o[e]&&o.splice(e,1)}}(t),Config.ShopData.splice(e,1),DataHelper.SaveData(),!0}return!1}function AddMoney(o,t){if(t<0)return!1;if("LLMoney"==Config.Money)return money.add(o,t);{let e=mc.getPlayer(o);return null!=e&&e.addScore(Config.Money,t)}}function ReduceMoney(e,o){return"LLMoney"==Config.Money?money.get(e.xuid)>=o&&money.reduce(e.xuid,o):e.getScore(Config.Money)>=o&&e.setScore(Config.Money,e.getScore(Config.Money)-o)}function GetMoney(e){return"LLMoney"==Config.Money?money.get(e.xuid):e.getScore(Config.Money)}mc.regPlayerCmd("playershop add","添加一个玩家商店",(o,e)=>{var t=mc.newIntPos(o.blockPos.x,o.blockPos.y-1,o.blockPos.z,o.blockPos.dimid);let a=mc.getBlock(t);if(a.hasContainer()){var n=a.getContainer();if(27<n.size)o.tell("目前暂不支持大箱子");else{t=ILAPI_PosGetLand({x:t.x,y:t.y,z:t.z,dimid:t.dimid});if(!Land||ILAPI_GetOwer(t)==o.xuid||o.isOP()){let e=new AddShopForm(o,n);e.Display()}else o.tell("只能在你拥有的领地内创建商店，若没有领地可以使用 /land new 新建一个")}}else o.tell("请站在一个容器方块上执行这条指令")}),mc.regPlayerCmd("playershop","打开玩家商店",(e,o)=>{let a=mc.newSimpleForm();a=a.setTitle(Format.Bold+Format.DarkAqua+"所有玩家商店"),0<Config.ShopData.length?(a=a.setContent(Format.Aqua+"注： 排名不分先后"),Config.ShopData.forEach(e=>{var o=data.xuid2name(e.Shopkeeper),t=e.Name,e=mc.newIntPos(e.Pos.x,e.Pos.y,e.Pos.z,e.Pos.dimid),e=e.x+" "+e.y+" "+e.z+" "+e.dim;a=a.addButton("§f["+Format.DarkAqua+o+"§f]"+Format.Yellow+t+"§r("+Format.Red+Format.Italics+e+"§r)")})):a=a.setContent(Format.Red+"空空如也");e.sendForm(a,function(o,a){if(null!=a){let t=Config.ShopData[a];if(t.Pos.dimid!=o.pos.dimid||t.Pos.x>o.pos.x+256||t.Pos.x<o.pos.x-256||t.Pos.z>o.pos.z+256||t.Pos.z<o.pos.z-256){let e=mc.getBlock(t.Pos.x,t.Pos.y,t.Pos.z,t.Pos.dimid);if(null==e||!e.hasContainer())return void o.sendModalForm("错误","该商店离你太远了，无法确保其所在区块已加载\n温馨提醒：无法保证商店所在坐标适合传送，贸然传送具有一定危险性。","确定","传送",(e,o)=>{0==o&&e.teleport(t.Pos.x,t.Pos.y,t.Pos.z,t.Pos.dimid)})}a=mc.newIntPos(t.Pos.x,t.Pos.y,t.Pos.z,t.Pos.dimid);let e=new ShopMain(o,a);e.Display()}})}),mc.regPlayerCmd("playershop remove","管理员强制移除一个玩家商店",(e,o)=>{e.isOP()&&(RemoveShop(mc.newIntPos(e.blockPos.x,e.blockPos.y-1,e.blockPos.z,e.blockPos.dimid))?e.tell("移除成功"):e.tell("移除失败"))},1),mc.regPlayerCmd("playershop list","列出所有玩家商店",(t,e)=>{t.tell("商店列表如下："),Config.ShopKeepers.forEach((e,o)=>{t.tell(data.xuid2name(o)+"："),e?.forEach(e=>{t.tell("    "+e+"，")})})},1),mc.regPlayerCmd("playershop mgr","GUI设置",(e,o)=>{e.isOP()&&e.sendForm(SettingForm.MainForm(),SettingForm.Main)},1),mc.regPlayerCmd("opshop","打开OP箱子商店",(e,o)=>{let t=mc.newSimpleForm();t=t.setTitle(Format.Bold+Format.MinecoinGold+"所有OP商店");let n=new Array;t=0<Config.ShopData.length?(Config.ShopData.forEach(e=>{var o;e.IsOpShop&&(o=e.Name,n.push(e),t=t.addButton("§f["+Format.Red+"OP§f]"+Format.Yellow+o))}),0<n.length?t.setContent(Format.Aqua+"OP商店列表："):t.setContent(Format.Red+"空空如也")):t.setContent(Format.Red+"空空如也");e.sendForm(t,function(a,e){if(null!=e){let r=n[e];var e=(o=function(){let o=mc.newSimpleForm();return o=o.setTitle(r.Name),0<r.Goods.length?(o=o.setContent(Format.Bold+Format.Aqua+"欢迎光临！\n您当前余额为："+Format.MinecoinGold+GetMoney(a)),r.Goods.forEach(e=>{e=e.DisplayName;o=o.addButton(Format.Bold+e)}),{resault:!0,form:o}):(o=o.setContent(Format.Bold+Format.Aqua+"欢迎光临！\n您当前余额为："+Format.MinecoinGold+GetMoney(a)+Format.Bold+Format.Red+"\n全部商品已售罄，赶快提醒店主补货吧！"),o=o.addButton("I just wanna tell you how I felling","https://img.wenhairu.com/images/2021/09/12/G4sGd.th.jpg"),o=o.addButton("Gotta make you understand","https://img.wenhairu.com/images/2021/09/12/G424H.th.jpg"),o=o.addButton("Never gonna give you up\nNaver gonna let you down","https://img.wenhairu.com/images/2021/09/11/G4geA.th.jpg"),o=o.addButton("Never gonna run around and desert you","https://img.wenhairu.com/images/2021/09/12/G4iAf.th.jpg"),{resault:!1,form:o})}()).form,o=o.resault;a.sendForm(e,(e,o)=>{let s=r.Goods[o];e.sendForm(function(e){let o=mc.newCustomForm();o=o.setTitle(Format.DarkAqua+"结账"),o=o.addLabel(Format.Aqua+"当前余额§r："+Format.MinecoinGold+GetMoney(a)+"金币");let t;t=r.ShowNbt?"\n商品NBT："+NBT.parseSNBT(e.Snbt):"";return o=o.addLabel("商品名称："+e.DisplayName+"\n商品单价："+e.Price+"\n商品库存：无限"+t),o=o.addSlider("购买数量",0,NBT.parseSNBT(e.Snbt).getData("Count"),1,1),o}(s),(e,o)=>{let t=NBT.parseSNBT(s.Snbt);t.setByte("Count",Number(o[2]));var a=s.Price*Number(o[2]);if(GetMoney(e)<a)e.sendModalForm("错误","余额不足，交易失败。","确定","取消",(e,o)=>{});else{var n=a*(1-Config.TaxRate),n=Math.round(n),i=ReduceMoney(e,a),o=AddMoney(r.Shopkeeper,n);if(!o&&e.xuid!=r.Shopkeeper)return AddMoney(e.xuid,a),void("LLMoney"==Config.Money?e.sendModalForm("错误","店主收款失败，交易无法继续。","确定","取消",(e,o)=>{}):e.sendModalForm("错误","店主收款失败，或者店主不在线，交易无法继续。","确定","取消",(e,o)=>{}));1==i&&1==o&&(o=mc.newItem(t),e.giveItem(o)),r.Turnover+=n,r.TotalSales+=1,DataHelper.SaveData(),e.sendSimpleForm("成功","交易完成。",["确定"],[""],(e,o)=>{}),logger.info(e.realName+"在"+r.Name+"完成了一笔交易，金额："+a+"，应纳税额："+(a-n)+"，店主实际收益："+n)}})})}})}),mc.listen("onOpenContainer",(a,n)=>{if(Config.ShopKeepers.has(a.xuid)){var o=n.pos.x+" "+n.pos.y+" "+n.pos.z+" "+n.pos.dimid,t=Config.ShopKeepers.get(a.xuid);if(null!=t)for(let e=0;e<t.length;e++)if(t[e]==o){let e=new ShopBackstageManagementForm(a,n);return e.Display(),!1}}var i={x:n.pos.x,y:n.pos.y,z:n.pos.z,dimid:n.pos.dimid};for(let e=0;e<Config.ShopData.length;e++){var s=Config.ShopData[e];if(JSON.stringify(s.Pos)==JSON.stringify(i)){if(a.isOP())a.sendSimpleForm(Format.Bold+Format.DarkAqua+"箱子商店","Choose...\n注： 此页面仅对OP显示",["进入商店","进入后台"],["",""],(e,t)=>{if(null!=t)switch(t){case 0:let e=new ShopMain(a,n.pos);e.Display();break;case 1:let o=new ShopBackstageManagementForm(a,n);o.Display()}});else{let e=new ShopMain(a,n.pos);e.Display()}return!1}}}),mc.listen("onDestroyBlock",(o,e)=>{let t=!0,a={x:e.pos.x,y:e.pos.y,z:e.pos.z,dimid:e.pos.dimid};return Config.ShopData.forEach(e=>{JSON.stringify(e.Pos)==JSON.stringify(a)&&(o.sendModalForm("警告","请不要破坏一个未删除的箱子商店，如果需要破坏请先删除它！","确定","取消",(e,o)=>{}),t=!1)}),t}),mc.listen("onHopperSearchItem",o=>{let t=!0;for(let e=0;e<ShopPosList.length;e++){var a=ShopPosList[e];o.x>a.x-1&&o.x<a.x+1&&o.y>a.y-2&&o.y<a.y+2&&o.z>a.z-1&&o.z<a.z+1&&o.dimid==a.dimid&&(t=!1)}return t}),mc.listen("onPistonPush",(e,o)=>{for(let e=0;e<ShopPosList.length;e++){var t=ShopPosList[e];if(o.pos.x==t.x&&o.pos.y==t.y&&o.pos.z==t.z&&o.pos.dimid==t.dimid)return!1}}),mc.listen("onHopperPushOut",o=>{for(let e=0;e<ShopPosList.length;e++){var t=ShopPosList[e];if(o.x>t.x-.7&&o.x<t.x+.7&&o.y>t.y-.2&&o.y<t.y+1.5&&o.z>t.z-.7&&o.z<t.z+.7&&o.dimid==t.dimid)return!1}}),mc.listen("onPlaceBlock",(e,a)=>{if("minecraft:chest"==a.type||"minecraft:trapped_chest"==a.type)return!function(){for(let o=0;o<ShopPosList.length;o++){var t=ShopPosList[o];let e;if(t.y==a.pos.y&&t.dimid==a.pos.dimid)if(t.x+1!=a.pos.x&&t.x-1!=a.pos.x||t.z!=a.pos.z){if((t.z+1==a.pos.z||t.z-1==a.pos.z)&&t.x==a.pos.x&&(e=mc.getBlock(t),null!=e&&e.type==a.type))return!0}else if(e=mc.getBlock(t),null!=e&&e.type==a.type)return!0}return!1}()});class Configuration{constructor(e){this.dataHelper=new DataHelper,null==e?(this.Money="LLMoney",this.Reg=0,this.TaxRate=0,this.ShopKeepers=new Map):(this.Money=null==e.Money?"LLMoney":e.Money,this.Reg=null==e.Reg?0:e.Reg,this.TaxRate=null==e.TaxRate?.1:e.TaxRate,(this.TaxRate<0||1<=this.TaxRate)&&(this.TaxRate=.1),null!=e.ShopKeepers?this.ShopKeepers=new Map(Object.entries(e.ShopKeepers)):this.ShopKeepers=new Map),this.ShopData=this.dataHelper.ShopData}}class DataHelper{constructor(){this.path=Dir+"data.json",file.exists(this.path)?this.ShopData=JSON.parse(file.readFrom(this.path)):this.ShopData=new Array}static SaveData(){let t={};Config.ShopKeepers.forEach((e,o)=>{t[o]=e});var e={Money:Config.Money,Reg:Config.Reg,TaxRate:Config.TaxRate,ShopKeepers:t};file.writeTo(Dir+"Config.json",JSON.stringify(e,void 0,4)),file.writeTo(Dir+"data.json",JSON.stringify(Config.ShopData,void 0,DEBUG?4:0)),updateShopList()}}class Commodity{constructor(e,o,t,a,n){this.DisplayName=e,this.Index=o,this.Price=t,this.Nbt=a,this.Snbt=n}}class PlayerShopModel{constructor(){this.ShowNbt=!0,this.IsOpShop=!1,this.Goods=new Array}}class ShopMain{constructor(e,o){this.Player=e,this.Form=mc.newSimpleForm();let t={x:o.x,y:o.y,z:o.z,dimid:o.dimid};Config.ShopData.forEach(e=>{JSON.stringify(e.Pos)==JSON.stringify(t)&&(this.Shop=e,ShopMain.Shops.set(this.Player.xuid,this.Shop))})}GuiHelper(){return null!=this.Shop&&(this.Form=this.Form.setTitle(this.Shop.Name),0<this.Shop.Goods.length?(this.Form=this.Form.setContent(Format.Bold+Format.Aqua+"欢迎光临！\n您当前余额为："+Format.MinecoinGold+GetMoney(this.Player)),this.Shop.Goods.forEach(e=>{e=e.DisplayName;this.Form=this.Form.addButton(Format.Bold+e)}),!0):(this.Form=this.Form.setContent(Format.Bold+Format.Aqua+"欢迎光临！\n您当前余额为："+Format.MinecoinGold+GetMoney(this.Player)+Format.Bold+Format.Red+"\n全部商品已售罄，赶快提醒店主补货吧！"),this.Form=this.Form.addButton("I just wanna tell you how I felling","https://img.wenhairu.com/images/2021/09/12/G4sGd.th.jpg"),this.Form=this.Form.addButton("Gotta make you understand","https://img.wenhairu.com/images/2021/09/12/G424H.th.jpg"),this.Form=this.Form.addButton("Never gonna give you up\nNaver gonna let you down","https://img.wenhairu.com/images/2021/09/11/G4geA.th.jpg"),this.Form=this.Form.addButton("Never gonna run around and desert you","https://img.wenhairu.com/images/2021/09/12/G4iAf.th.jpg"),!1))}static GuiCallBack(o,t){if(null!=t){let e=new CheckoutForm(o,t);e.Display()}}Display(){if(this.GuiHelper())this.Player.sendForm(this.Form,ShopMain.GuiCallBack);else if(null!=this.Shop){let e=this.Player;setTimeout(()=>{e.sendForm(this.Form,(e,o)=>{})},200)}}}ShopMain.Shops=new Map;class CheckoutForm{constructor(e,o){this.Player=e,this.PlayerChoose=o,this.Form=mc.newCustomForm()}GuiHelper(){var a=ShopMain.Shops.get(this.Player.xuid);if(null==a)return!1;{let e=mc.getBlock(mc.newIntPos(a.Pos.x,a.Pos.y,a.Pos.z,a.Pos.dimid)).getContainer();var n=a.Goods[this.PlayerChoose];let o=e.getItem(n.Index);if(o.isNull())return this.Player.sendSimpleForm("错误","呜呜~ 商品不存在，可能已经售罄了。\n赶快提醒店主补货吧！",["确定"],["https://img.wenhairu.com/images/2021/09/11/G4geA.th.jpg"],(e,o)=>{}),!1;CheckoutForm.Commodity.set(this.Player.xuid,n),this.Form=this.Form.setTitle(Format.DarkAqua+"结账"),this.Form=this.Form.addLabel(Format.Aqua+"当前余额§r："+Format.MinecoinGold+GetMoney(this.Player)+"金币");let t;t=a.ShowNbt?"\n商品NBT："+o.getNbt().toString():"";a=a.IsOpShop?"无限":o.getNbt().getData("Count");return this.Form=this.Form.addLabel("商品名称："+n.DisplayName+"\n商品单价："+n.Price+"\n商品库存："+a+t),this.Form=this.Form.addSlider("购买数量",0,o.count,1,1),!0}}static GuiCallback(t,a){let n=ShopMain.Shops.get(t.xuid),i=CheckoutForm.Commodity.get(t.xuid);if(null!=n&&null!=i&&null!=a){let e=mc.getBlock(mc.newIntPos(n.Pos.x,n.Pos.y,n.Pos.z,n.Pos.dimid)).getContainer(),o=e.getItem(i.Index);var s=i.Price*Number(a[2]);if(GetMoney(t)<s)return void t.sendModalForm("错误","余额不足，交易失败。","确定","取消",(e,o)=>{});var r=s*(1-Config.TaxRate),r=Math.round(r),l=ReduceMoney(t,s),m=AddMoney(n.Shopkeeper,r);if(!m&&t.xuid!=n.Shopkeeper)return AddMoney(t.xuid,s),void("LLMoney"==Config.Money?t.sendModalForm("错误","店主收款失败，交易无法继续。","确定","取消",(e,o)=>{}):t.sendModalForm("错误","店主收款失败，或者店主不在线，交易无法继续。","确定","取消",(e,o)=>{}));if(1==l&&1==m){let e=o.getNbt();e=e.setByte("Count",Number(a[2]));m=mc.newItem(e);if(t.giveItem(m),e.destroy(),n.IsOpShop||o.setNbt(o.getNbt().setByte("Count",o.getNbt().getData("Count")-Number(a[2]))),0==o.getNbt().getData("Count")){o.setNull();let t;n.Goods.forEach((e,o)=>{e.Index===i?.Index&&(t=o)}),null!=t&&n.Goods.splice(t,1)}n.Turnover+=r,n.TotalSales+=1,n.IsOpShop||(i.Nbt.Count-=Number(a[2])),DataHelper.SaveData(),t.sendSimpleForm("成功","交易完成。",["确定"],[""],(e,o)=>{}),logger.info(t.realName+"在"+n.Name+"完成了一笔交易，金额："+s+"，应纳税额："+(s-r)+"，店主实际收益："+r)}}ShopMain.Shops.delete(t.xuid),CheckoutForm.Commodity.delete(t.xuid)}Display(){this.GuiHelper()&&this.Player.sendForm(this.Form,CheckoutForm.GuiCallback)}}CheckoutForm.Commodity=new Map;class AddShopForm{constructor(e,o){this.Player=e,this.Form=mc.newCustomForm(),this.Items=new Map;for(let e=0;e<o.size;e++)o.getItem(e).isNull()||this.Items.set(e,o.getItem(e))}GuiHelper(){this.Form=this.Form.setTitle("设置玩家商店"),this.Form=this.Form.addLabel("注册这个小店您需要支付"+Config.Reg+"金币。\n当前存款："+GetMoney(this.Player)+"金币"),this.Items.forEach(e=>{this.Form=this.Form.addLabel("\n物品名称："+e.name+"\n物品数量："+e.count+"\n物品数据："+e.getNbt().toString()),this.Form=this.Form.addInput("输入单价：","物品单价")}),AddShopForm.FormData.set(this.Player.xuid,this.Items)}static GuiCallback(s,r){if(null!=r){let a=new PlayerShopModel;a.Name=Format.Bold+Format.Yellow+s.name+Format.Clear+"的小店",a.Shopkeeper=s.xuid,a.Turnover=0,a.TotalSales=0,a.ContainerType=mc.getBlock(s.blockPos.x,s.blockPos.y-1,s.blockPos.z,s.blockPos.dimid).type,a.Pos={x:s.blockPos.x,y:s.blockPos.y-1,z:s.blockPos.z,dimid:s.blockPos.dimid},Config.ShopData.forEach(e=>{e.Pos==a.Pos&&s.sendModalForm("错误","商店已存在","确定","取消",(e,o)=>{})});let n=AddShopForm.FormData.get(s.xuid);AddShopForm.FormData.delete(s.xuid);let i=0;for(let t=2;t<r.length;t+=2){var l=r[t];let e;if(""==l)return void s.sendModalForm("错误","价格不能留空","确定","取消",(e,o)=>{});try{e=Number(l)}catch{return void s.sendModalForm("错误","价格只允许整数","确定","取消",(e,o)=>{})}if(null==e||e<0||!Number.isInteger(e))return void s.sendModalForm("错误","价格不能留空，且只允许大于零的整数","确定","取消",(e,o)=>{});let o=n.get(i);l=new Commodity(o.name,i,e,o.getNbt().toObject(),o.getNbt().toSNBT());a.Goods.push(l),i++}var e;ReduceMoney(s,Config.Reg)?(Config.ShopData.push(a),Config.ShopKeepers.has(s.xuid)||Config.ShopKeepers.set(s.xuid,new Array),Config.ShopKeepers.get(s.xuid)?.push(a.Pos.x+" "+a.Pos.y+" "+a.Pos.z+" "+a.Pos.dimid),DataHelper.SaveData(),s.sendModalForm("成功","您的新商店已成功注册","确定","取消",(e,o)=>{}),e=s.blockPos.dim+" "+s.blockPos.x+" "+s.blockPos.y+" "+s.blockPos.z,logger.info(s.realName+"在<"+e+">创建了一个箱子商店")):s.sendModalForm("错误","创建失败","确定","取消",(e,o)=>{})}}Display(){let t=!1;if(Config.ShopKeepers.has(this.Player.xuid)){let o=this.Player.blockPos.x+" "+(this.Player.blockPos.y-1)+" "+this.Player.blockPos.z+" "+this.Player.blockPos.dimid;Config.ShopKeepers.get(this.Player.xuid)?.forEach(e=>{e==o&&(this.Player.sendModalForm("错误","不能重复注册","确定","取消",(e,o)=>{}),t=!0)})}t||(this.GuiHelper(),null!=this.Form&&this.Player.sendForm(this.Form,AddShopForm.GuiCallback))}}AddShopForm.FormData=new Map;class ShopBackstageManagementForm{constructor(e,o){this.Player=e;let t={x:(this.Chest=o).pos.x,y:o.pos.y,z:o.pos.z,dimid:o.pos.dimid};Config.ShopData.forEach(e=>{JSON.stringify(e.Pos)==JSON.stringify(t)&&(this.Shop=e)}),ShopBackstageManagementForm.Instances.set(this.Player.xuid,this)}MainForm(){let e=mc.newSimpleForm();return e=e.setTitle(Format.Green+"§l商店后台"),e=e.setContent("§l§b商店信息§r：\n§l店主：  §e"+mc.getPlayer(this.Shop.Shopkeeper).name+"\n§r§l商店名称：  §e"+this.Shop.Name+"\n§r§l税后营收：  §e"+this.Shop.Turnover+"§f(税率：百分之"+100*Config.TaxRate+")\n§r§l总成交数：  §e"+this.Shop.TotalSales+"\n"),e=e.addButton("进入商店","textures/items/apple_golden"),e=e.addButton("上架商品","textures/ui/share_apple"),e=e.addButton("编辑商品","textures/ui/debug_glyph_color"),e=e.addButton("编辑商店信息","textures/ui/creative_icon.png"),e=e.addButton("卷款跑路","textures/ui/crossout"),e}static Main(o,e){let a=ShopBackstageManagementForm.Instances.get(o.xuid);switch(e){case 0:var t=a?.Chest;if(null!=t){let e=new ShopMain(o,t.pos);e.Display()}break;case 1:null!=a&&(a.Player=o,null!=(t=a.AddItemForm())?o.sendForm(t,ShopBackstageManagementForm.AddItem):o.sendModalForm("错误","手上没有物品物品！","返回","取消",(e,o)=>{null!=o&&1==o&&a?.Display()}));break;case 2:null!=a&&(a.Player=o).sendForm(a.EditItemMainForm(),ShopBackstageManagementForm.EditItemMain);break;case 3:null!=a&&(a.Player=o).sendForm(a.EditShopInfoForm(),ShopBackstageManagementForm.EditShopInfo);break;case 4:o.sendModalForm("删除商店","您确定要删除这个商店的所有数据吗？（不可恢复）\n温馨提醒：商店注册费用将不会退还，箱子中剩余物品不会清除。","确定跑路","我点错了",(e,o)=>{var t=a?.Chest;null!=o&&null!=t&&(1==o?RemoveShop(t.pos)&&(e.tell("删除成功"),t=t.pos.dim+" "+t.pos.x+" "+t.pos.y+" "+t.pos.z,logger.info(e.realName+'从后台删除了一个商店（"卷款跑路"选项），商店名称：'+a?.Shop.Name+"，坐标："+t+"，店主："+a?.Shop.Shopkeeper)):e.tell("已取消"))})}}AddItemForm(){let e=mc.newCustomForm(),n=this.Chest.getContainer(),o=this.Player.getHand();if(!o.isNull()){e=e.setTitle("§l上架商品"),e=e.addLabel(Format.Gray+"=================§r§l上架手中的物品§r"+Format.Gray+"================"),e=e.addLabel("物品名称： "+o.name+"\n物品数量： "+o.count+"\n物品数据： "+o.getNbt().toString()),e=e.addInput("商品显示名称：","购买页面显示的名称",o.name),e=e.addInput("商品价格：","输入商品价格");let t=new Array,a={};for(let o=0;o<n.size;o++){let e=n.getItem(o);var i;e.isNull()&&(i=t.push("格子"+(o+1)),a[i-1]=o)}return e=e.addDropdown("选择一个空的格子",t),ShopBackstageManagementForm.FormData.set(this.Player.xuid,a),e}}static AddItem(a,o){let n=ShopBackstageManagementForm.Instances.get(a.xuid);if(null!=n&&null!=o){let t=a.getHand();var i=ShopBackstageManagementForm.FormData.get(a.xuid)[Number(o[4])],s=o[2],r=Number(o[3]);let e=t.getNbt();var l=e.toSNBT();if(null==o[3]||r<=0||!Number.isInteger(r))a.sendModalForm("错误","价格不能留空，且只允许大于零的整数","确定","取消",(e,o)=>{});else{l=new Commodity(s,i,r,e,l);let o=n.Chest.getContainer();if(o.hasRoomFor(t)){let e=mc.newItem(t.getNbt());o.setItem(i,e)?(e.setLore(["From FantasyChestShop"]),n.Shop.Goods.push(l),t.setNull(),a.refreshItems(),a.sendModalForm("成功","商品添加成功！","返回","取消",(e,o)=>{null!=o&&1==o&&n?.Display()}),DataHelper.SaveData()):a.sendModalForm("错误","商品添加失败！\n未知原因","返回","取消",(e,o)=>{null!=o&&1==o&&n?.Display()})}else a.sendModalForm("错误","商品添加失败！\n当前箱子没有足够的空间","确定","取消",(e,o)=>{null!=o&&1==o&&n?.Display()})}}}EditItemMainForm(){let o=mc.newSimpleForm();if(null!=this.Shop&&0<this.Shop.Goods.length)o=o.setTitle("§l编辑商品"),o=o.setContent(Format.Bold+Format.Aqua+"全部商品："),this.Shop.Goods.forEach(e=>{e=e.DisplayName;o=o.addButton(Format.Bold+e)});else{o=o.setTitle("§l编辑商品"),o=o.setContent(Format.Bold+Format.Aqua+"欢迎光临！"+Format.Bold+Format.Red+"\n全部商品已售罄，赶快补货吧！");let e=this;setTimeout(()=>{e.Display()},1e3)}return o}static EditItemMain(n,e){let i=ShopBackstageManagementForm.Instances.get(n.xuid),s,r;null!=e&&null!=i&&(s=e,r=i.Shop.Goods[s],n.sendForm(function(){let e=mc.newCustomForm();return e=e.setTitle("§l编辑商品"),e=e.addLabel(Format.Gray+"=================§r§l编辑商品信息§r"+Format.Gray+"================\n"+Format.Aqua+'勾选"下架"后，需将价格设置为小于零的值（防止误操作）'),e=e.addInput("商品显示名称：","商品显示的名称",r.DisplayName),e=e.addInput("商品价格：","价格",r.Price.toString()),e=e.addSwitch("下架该商品",!1),e}(),function(t,e){if(null!=e&&null!=i){var o=e[1],a=Number(e[2]);if(1==e[3]&&a<0){let e=i.Chest.getContainer(),o=e.getItem(r.Index);t.giveItem(o)&&(o.setNull(),i.Shop.Goods.splice(s,1),n.sendModalForm("成功","商品已下架","返回","取消",(e,o)=>{null!=o&&1==o&&i?.Display()}))}else{if(!(Number.isInteger(a)&&0<a))return void t.sendModalForm("错误","输入的信息有误！","返回","取消",(e,o)=>{null!=o&&1==o&&i?.Display()});r.DisplayName!=o&&(r.DisplayName=o),r.Price!=a&&(r.Price=a),n.sendModalForm("成功","商品信息已更新","返回","取消",(e,o)=>{null!=o&&1==o&&i?.Display()})}DataHelper.SaveData()}}))}EditShopInfoForm(){let e=mc.newCustomForm();return e=e.setTitle("§l编辑商店信息"),e=e.addInput("商店名称","填入商店名称",this.Shop.Name),e=e.addSwitch("是否显示商品NBT",this.Shop.ShowNbt),this.Player.isOP()&&(e=e.addInput("营业额 （对非OP玩家此项会自动隐藏）","",this.Shop.Turnover.toString()),e=e.addInput("成交数 （对非OP玩家此项会自动隐藏）","",this.Shop.TotalSales.toString()),e=e.addSwitch("无限库存 （对非OP玩家此项会自动隐藏）",this.Shop.IsOpShop)),e}static EditShopInfo(a,n){let i=ShopBackstageManagementForm.Instances.get(a.xuid);if(null!=n&&null!=i){var s=String(n[0]).trim(),r=Boolean(n[1]);if(""!=s&&null!=n[1]){let e=n[2],o=n[3],t=n[4];if(a.isOP()&&null!=e&&null!=o&&null!=t){if(e=Number(n[2]),o=Number(n[3]),t=Boolean(n[4]),!(0<=e&&0<=o))return void a.sendModalForm("错误","输入的信息有误","返回","取消",(e,o)=>{null!=o&&1==o&&i?.Display()});i.Shop.Turnover=e,i.Shop.TotalSales=o,i.Shop.IsOpShop=t}i.Shop.Name=s,i.Shop.ShowNbt=r,DataHelper.SaveData(),a.sendModalForm("成功","商店信息已更新","返回","取消",(e,o)=>{null!=o&&1==o&&i?.Display()})}else a.sendModalForm("错误","输入的信息有误","返回","取消",(e,o)=>{null!=o&&1==o&&i?.Display()})}}Display(){this.Player.sendForm(this.MainForm(),ShopBackstageManagementForm.Main)}}ShopBackstageManagementForm.Instances=new Map,ShopBackstageManagementForm.FormData=new Map;class SettingForm{static MainForm(){let e=mc.newCustomForm();return e=e.setTitle("设置"),e=e.addLabel(Format.Gray+"===================§r§l插件设置§r"+Format.Gray+"=================="),e=e.addInput(Format.Aqua+"Money （默认LLMoney）§r - 经济种类",'填"LLMoney"或其他任意字符串',Config.Money),e=e.addInput(Format.Aqua+"Registration fee§r - 开店手续费","填整数",Config.Reg.toString()),e=e.addSlider(Format.Aqua+"Tax rate§r - 税率  §e百分之",0,95,5,100*Config.TaxRate),e}static Main(o,t){if(null!=t){let e=t[1];var a=t[2],t=t[3];null==e||""==e.trim()?o.sendModalForm("错误","输入的Money类型有误","确定","取消",(e,o)=>{}):null==a||Number(a)<0||!Number.isInteger(Number(a))?o.sendModalForm("错误","Registration fee不能为空或小于0","确定","取消",(e,o)=>{}):null==t||t<0||100<=t?o.sendModalForm("错误","输入的数据有误","确定","取消",(e,o)=>{}):(Config.Money=e,Config.Reg=Number(a),Config.TaxRate=t/100,o.sendModalForm("成功","设置已生效","确定","取消",(e,o)=>{}),DataHelper.SaveData())}}}