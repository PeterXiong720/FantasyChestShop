"use strict";var ILAPI_PosGetLand,ILAPI_GetOwer;mc.listen("onServerStarted",()=>{ILAPI_PosGetLand=lxl.import("ILAPI_PosGetLand"),ILAPI_GetOwer=lxl.import("ILAPI_GetOwner"),init(),updateShopList()});var Config,DEBUG=!1,Dir="./Plugins/PlayerShop/",ShopPosList=new Array;function init(){file.exists(Dir)||file.mkdir(Dir),file.exists(Dir+"Config.json")?Config=new Configuration(JSON.parse(file.readFrom(Dir+"Config.json"))):(Config=new Configuration,DataHelper.SaveData())}function updateShopList(){ShopPosList=new Array,Config.ShopData.forEach(e=>{null!=e&&(e=mc.newIntPos(e.Pos.x,e.Pos.y,e.Pos.z,e.Pos.dimid),ShopPosList.push(e))})}function RemoveShop(i){var t={x:i.x,y:i.y,z:i.z,dimid:i.dimid};for(let e=0;e<Config.ShopData.length;e++){var o=Config.ShopData[e];if(null!=o&&JSON.stringify(o.Pos)==JSON.stringify(t))return function(e){let t=Config.ShopKeepers.get(e.Shopkeeper);if(null!=t){var o=i.x+" "+i.y+" "+i.z+" "+i.dimid;for(let e=0;e<t.length;e++)o==t[e]&&t.splice(e,1)}}(o),Config.ShopData.splice(e,1),DataHelper.SaveData(),!0}return!1}function AddMoney(t,o){if(o<0)return!1;if("LLMoney"==Config.Money)return money.add(t,o);{let e=mc.getPlayer(t);return null!=e&&e.addScore(Config.Money,o)}}function ReduceMoney(e,t){return"LLMoney"==Config.Money?money.get(e.xuid)>=t&&money.reduce(e.xuid,t):e.getScore(Config.Money)>=t&&e.setScore(Config.Money,e.getScore(Config.Money)-t)}function GetMoney(e){return"LLMoney"==Config.Money?money.get(e.xuid):e.getScore(Config.Money)}mc.regPlayerCmd("playershop add","添加一个玩家商店",(t,e)=>{var o=mc.newIntPos(t.blockPos.x,t.blockPos.y-1,t.blockPos.z,t.blockPos.dimid);let i=mc.getBlock(o);if(i.hasContainer()){var a=i.getContainer();if(27<a.size)t.tell("目前暂不支持大箱子");else{o=ILAPI_PosGetLand({x:o.x,y:o.y,z:o.z,dimid:o.dimid});if(ILAPI_GetOwer(o)==t.xuid||t.isOP()){let e=new AddShopForm(t,a);e.Display()}else t.tell("只能在你拥有的领地内创建商店，若没有领地可以使用 /land new 新建一个")}}else t.tell("请站在一个容器方块上执行这条指令")}),mc.regPlayerCmd("playershop","打开玩家商店",(e,t)=>{if(0<Config.ShopData.length){let i=mc.newSimpleForm();i=i.setTitle(Format.Bold+Format.DarkAqua+"所有玩家商店"),i=i.setContent(Format.Aqua+"注： 排名不分先后"),Config.ShopData.forEach(e=>{var t=mc.getPlayer(e.Shopkeeper).name,o=e.Name,e=e.Pos.x+"-"+e.Pos.y+"-"+e.Pos.z+"-"+e.Pos.dimid;i=i.addButton("§f["+Format.DarkAqua+t+"§f]"+Format.Yellow+o+"§r("+Format.Red+Format.Italics+e+"§r)")});e.sendForm(i,function(t,o){if(null!=o){o=Config.ShopData[o],o=mc.newIntPos(o.Pos.x,o.Pos.y,o.Pos.z,o.Pos.dimid);let e=new ShopMain(t,o);e.Display()}})}}),mc.regPlayerCmd("playershop remove","管理员强制移除一个玩家商店",(e,t)=>{e.isOP()&&(RemoveShop(mc.newIntPos(e.blockPos.x,e.blockPos.y-1,e.blockPos.z,e.blockPos.dimid))?e.tell("移除成功"):e.tell("移除失败"))},1),mc.regPlayerCmd("playershop list","列出所有玩家商店",(o,e)=>{o.tell("商店列表如下："),Config.ShopKeepers.forEach((e,t)=>{o.tell(mc.getPlayer(t).name+"："),e?.forEach(e=>{o.tell("    "+e+"，")})})},1),mc.listen("onOpenContainer",(t,o)=>{let i=!0;if(Config.ShopKeepers.has(t.xuid)){var a=o.pos.x+" "+o.pos.y+" "+o.pos.z+" "+o.pos.dimid,s=Config.ShopKeepers.get(t.xuid);if(null!=s)for(let e=0;e<s.length;e++)if(s[e]==a){let e=new ShopBackstageManagementForm(t,o);return e.Display(),!1}}let r={x:o.pos.x,y:o.pos.y,z:o.pos.z,dimid:o.pos.dimid};return Config.ShopData.forEach(e=>{if(JSON.stringify(e.Pos)==JSON.stringify(r)){let e=new ShopMain(t,o.pos);e.Display(),i=!1}}),i}),mc.listen("onDestroyBlock",(t,e)=>{let o=!0,i={x:e.pos.x,y:e.pos.y,z:e.pos.z,dimid:e.pos.dimid};return Config.ShopData.forEach(e=>{JSON.stringify(e.Pos)==JSON.stringify(i)&&(t.sendModalForm("警告","请不要破坏一个未删除的箱子商店，如果需要破坏请先删除它！","确定","取消",(e,t)=>{}),o=!1)}),o}),mc.listen("onHopperSearchItem",t=>{let o=!0;for(let e=0;e<ShopPosList.length;e++){var i=ShopPosList[e];t.x>i.x-1&&t.x<i.x+1&&t.y>i.y-2&&t.y<i.y+2&&t.z>i.z-1&&t.z<i.z+1&&t.dimid==i.dimid&&(o=!1)}return o}),mc.listen("onPistonPush",(e,t)=>{for(let e=0;e<ShopPosList.length;e++){var o=ShopPosList[e];if(t.pos.x==o.x&&t.pos.y==o.y&&t.pos.z==o.z&&t.pos.dimid==o.dimid)return!1}});class Configuration{constructor(e){this.dataHelper=new DataHelper,null==e?(this.Money="LLMoney",this.Reg=0,this.TaxRate=0,this.ShopKeepers=new Map):(this.Money=null==e.Money?"LLMoney":e.Money,this.Reg=null==e.Reg?0:e.Reg,this.TaxRate=null==e.TaxRate?0:e.TaxRate,(this.TaxRate<0||1<=this.TaxRate)&&(this.TaxRate=0),null!=e.ShopKeepers?this.ShopKeepers=new Map(Object.entries(e.ShopKeepers)):this.ShopKeepers=new Map),this.ShopData=this.dataHelper.ShopData}}class DataHelper{constructor(){this.path=Dir+"data.json",file.exists(this.path)?this.ShopData=JSON.parse(file.readFrom(this.path)):this.ShopData=new Array}static SaveData(){let o={};Config.ShopKeepers.forEach((e,t)=>{o[t]=e});var e={Money:Config.Money,Reg:Config.Reg,TaxRate:Config.TaxRate,ShopKeepers:o};file.writeTo(Dir+"Config.json",JSON.stringify(e,void 0,4)),file.writeTo(Dir+"data.json",JSON.stringify(Config.ShopData,void 0,DEBUG?4:0)),updateShopList()}}class Commodity{constructor(e,t,o,i,a){this.DisplayName=e,this.Index=t,this.Price=o,this.Nbt=i,this.Snbt=a}}class PlayerShopData{constructor(){this.Goods=new Array}}class ShopMain{constructor(e,t){this.Player=e,this.Form=mc.newSimpleForm();let o={x:t.x,y:t.y,z:t.z,dimid:t.dimid};Config.ShopData.forEach(e=>{JSON.stringify(e.Pos)==JSON.stringify(o)&&(this.Shop=e,ShopMain.Shops.set(this.Player.xuid,this.Shop))})}GuiHelper(){return null!=this.Shop&&(this.Form=this.Form.setTitle(this.Shop.Name),0<this.Shop.Goods.length?(this.Form=this.Form.setContent(Format.Bold+Format.Aqua+"欢迎光临！\n您当前余额为："+Format.MinecoinGold+GetMoney(this.Player)),this.Shop.Goods.forEach(e=>{e=e.DisplayName;this.Form=this.Form.addButton(Format.Bold+e)}),!0):(this.Form=this.Form.setContent(Format.Bold+Format.Aqua+"欢迎光临！\n您当前余额为："+Format.MinecoinGold+GetMoney(this.Player)+Format.Bold+Format.Red+"\n全部商品已售罄，赶快提醒店主补货吧！"),this.Form=this.Form.addButton("I just wanna tell you how I felling","https://img.wenhairu.com/images/2021/09/12/G4sGd.th.jpg"),this.Form=this.Form.addButton("Gotta make you understand","https://img.wenhairu.com/images/2021/09/12/G424H.th.jpg"),this.Form=this.Form.addButton("Never gonna give you up\nNaver gonna let you down","https://img.wenhairu.com/images/2021/09/11/G4geA.th.jpg"),this.Form=this.Form.addButton("Never gonna run around and desert you","https://img.wenhairu.com/images/2021/09/12/G4iAf.th.jpg"),!1))}static GuiCallBack(t,o){if(null!=o){let e=new CheckoutForm(t,o);e.Display()}}Display(){if(this.GuiHelper())this.Player.sendForm(this.Form,ShopMain.GuiCallBack);else if(null!=this.Shop){let e=this.Player;setTimeout(()=>{e.sendForm(this.Form,(e,t)=>{})},200)}}}ShopMain.Shops=new Map;class CheckoutForm{constructor(e,t){this.Player=e,this.PlayerChoose=t,this.Form=mc.newCustomForm()}GuiHelper(){var o=ShopMain.Shops.get(this.Player.xuid);if(null==o)return!1;{let e=mc.getBlock(mc.newIntPos(o.Pos.x,o.Pos.y,o.Pos.z,o.Pos.dimid)).getContainer();o=o.Goods[this.PlayerChoose];let t=e.getItem(o.Index);return t.isNull()?(this.Player.sendSimpleForm("错误","呜呜~ 商品不存在，可能已经售罄了。\n赶快提醒店主补货吧！",["确定"],["https://img.wenhairu.com/images/2021/09/11/G4geA.th.jpg"],(e,t)=>{}),!1):(CheckoutForm.Commodity.set(this.Player.xuid,o),this.Form=this.Form.setTitle(Format.DarkAqua+"结账"),this.Form=this.Form.addLabel(Format.Aqua+"当前余额§r："+Format.MinecoinGold+GetMoney(this.Player)+"金币"),this.Form=this.Form.addLabel("商品名称："+o.DisplayName+"\n商品单价："+o.Price+"\n商品库存："+t.getNbt().getData("Count")+"\n商品NBT："+t.getNbt().toString()),this.Form=this.Form.addSlider("购买数量",0,t.getNbt().getData("Count"),1,1),!0)}}static GuiCallback(o,i){let a=ShopMain.Shops.get(o.xuid),s=CheckoutForm.Commodity.get(o.xuid);if(null!=a&&null!=s&&null!=i){let e=mc.getBlock(mc.newIntPos(a.Pos.x,a.Pos.y,a.Pos.z,a.Pos.dimid)).getContainer(),t=e.getItem(s.Index);var r=s.Price*Number(i[2]);if(GetMoney(o)<r)return void o.sendModalForm("错误","余额不足，交易失败。","确定","取消",(e,t)=>{});var n=r*(1-Config.TaxRate),l=ReduceMoney(o,r),m=AddMoney(a.Shopkeeper,n);if(!m&&o.xuid!=a.Shopkeeper)return AddMoney(o.xuid,r),void("LLMoney"==Config.Money?o.sendModalForm("错误","店主收款失败，交易无法继续。","确定","取消",(e,t)=>{}):o.sendModalForm("错误","店主收款失败，或者店主不在线，交易无法继续。","确定","取消",(e,t)=>{}));if(1==l&&1==m){let e=t.getNbt();e=e.setByte("Count",Number(i[2]));m=mc.newItem(e);if(o.giveItem(m),e.destroy(),t.setNbt(t.getNbt().setByte("Count",t.getNbt().getData("Count")-Number(i[2]))),0==t.getNbt().getData("Count")){t.setNull();let o;a.Goods.forEach((e,t)=>{e.Index===s?.Index&&(o=t)}),null!=o&&a.Goods.splice(o,1)}a.Turnover+=n,a.TotalSales+=1,s.Nbt.Count-=Number(i[2]),DataHelper.SaveData(),o.sendSimpleForm("成功","交易完成。",["确定"],[""],(e,t)=>{})}}ShopMain.Shops.delete(o.xuid),CheckoutForm.Commodity.delete(o.xuid)}Display(){this.GuiHelper()&&this.Player.sendForm(this.Form,CheckoutForm.GuiCallback)}}CheckoutForm.Commodity=new Map;class AddShopForm{constructor(e,t){this.Player=e,this.Form=mc.newCustomForm(),this.Items=new Map;for(let e=0;e<t.size;e++)t.getItem(e).isNull()||this.Items.set(e,t.getItem(e))}GuiHelper(){this.Form=this.Form.setTitle("设置玩家商店"),this.Form=this.Form.addLabel("注册这个小店您需要支付"+Config.Reg+"金币。\n当前存款："+GetMoney(this.Player)+"金币"),this.Items.forEach(e=>{this.Form=this.Form.addLabel("\n物品名称："+e.name+"\n物品数量："+e.count+"\n物品数据："+e.getNbt().toString()),this.Form=this.Form.addInput("输入单价：","物品单价")}),AddShopForm.FormData.set(this.Player.xuid,this.Items)}static GuiCallback(r,n){if(null!=n){let i=new PlayerShopData;i.Name=Format.Bold+Format.Yellow+r.name+Format.Clear+"的小店",i.Shopkeeper=r.xuid,i.Turnover=0,i.TotalSales=0,i.Pos={x:r.blockPos.x,y:r.blockPos.y-1,z:r.blockPos.z,dimid:r.blockPos.dimid},Config.ShopData.forEach(e=>{e.Pos==i.Pos&&r.sendModalForm("错误","商店已存在","确定","取消",(e,t)=>{})});let a=AddShopForm.FormData.get(r.xuid);AddShopForm.FormData.delete(r.xuid);let s=0;for(let o=2;o<n.length;o+=2){var l=n[o];let e;if(""==l)return void r.sendModalForm("错误","价格不能留空","确定","取消",(e,t)=>{});try{e=Number(l)}catch{return void r.sendModalForm("错误","价格只允许整数","确定","取消",(e,t)=>{})}if(null==e||e<0||!Number.isInteger(e))return void r.sendModalForm("错误","价格不能留空，且只允许大于零的整数","确定","取消",(e,t)=>{});let t=a.get(s);l=new Commodity(t.name,s,e,t.getNbt().toObject(),t.getNbt().toSNBT());i.Goods.push(l),s++}ReduceMoney(r,Config.Reg)?(Config.ShopData.push(i),Config.ShopKeepers.has(r.xuid)||Config.ShopKeepers.set(r.xuid,new Array),Config.ShopKeepers.get(r.xuid)?.push(i.Pos.x+" "+i.Pos.y+" "+i.Pos.z+" "+i.Pos.dimid),DataHelper.SaveData(),r.sendModalForm("成功","您的新商店已成功注册","确定","取消",(e,t)=>{})):r.sendModalForm("错误","创建失败","确定","取消",(e,t)=>{})}}Display(){let o=!1;if(Config.ShopKeepers.has(this.Player.xuid)){let t=this.Player.blockPos.x+" "+(this.Player.blockPos.y-1)+" "+this.Player.blockPos.z+" "+this.Player.blockPos.dimid;Config.ShopKeepers.get(this.Player.xuid)?.forEach(e=>{e==t&&(this.Player.sendModalForm("错误","不能重复注册","确定","取消",(e,t)=>{}),o=!0)})}o||(this.GuiHelper(),null!=this.Form&&this.Player.sendForm(this.Form,AddShopForm.GuiCallback))}}AddShopForm.FormData=new Map;class ShopBackstageManagementForm{constructor(e,t){this.Player=e;let o={x:(this.Chest=t).pos.x,y:t.pos.y,z:t.pos.z,dimid:t.pos.dimid};Config.ShopData.forEach(e=>{JSON.stringify(e.Pos)==JSON.stringify(o)&&(this.Shop=e)}),ShopBackstageManagementForm.Instances.set(this.Player.xuid,this)}MainForm(){let e=mc.newSimpleForm();return e=e.setTitle(Format.Green+"§l商店后台"),e=e.setContent("§l§b商店信息§r：\n§l店主：  §e"+mc.getPlayer(this.Shop.Shopkeeper).name+"\n§r§l商店名称：  §e"+this.Shop.Name+"\n§r§l总营业额：  §e"+this.Shop.Turnover+"\n§r§l总成交数：  §e"+this.Shop.TotalSales+"\n"),e=e.addButton("进入商店","textures/items/apple_golden"),e=e.addButton("上架商品","textures/ui/share_apple"),e=e.addButton("编辑商品","textures/ui/debug_glyph_color"),e=e.addButton("编辑商店信息","textures/ui/creative_icon.png"),e=e.addButton("卷款跑路","textures/ui/crossout"),e}static Main(t,e){let i=ShopBackstageManagementForm.Instances.get(t.xuid);switch(e){case 0:var o=i?.Chest;if(null!=o){let e=new ShopMain(t,o.pos);e.Display()}break;case 1:null!=i&&(i.Player=t,null!=(o=i.AddItemForm())?t.sendForm(o,ShopBackstageManagementForm.AddItem):t.sendModalForm("错误","手上没有物品物品！","返回","取消",(e,t)=>{null!=t&&1==t&&i?.Display()}));break;case 2:null!=i&&(i.Player=t).sendModalForm("阿巴阿巴阿巴阿巴","尽情期待","返回","取消",(e,t)=>{null!=t&&1==t&&i?.Display()});break;case 3:null!=i&&(i.Player=t).sendModalForm("阿巴阿巴阿巴阿巴","尽情期待","返回","取消",(e,t)=>{null!=t&&1==t&&i?.Display()});break;case 4:t.sendModalForm("删除商店","您确定要删除这个商店的所有数据吗？（不可恢复）\n温馨提醒：商店注册费用将不会退还，箱子中剩余物品不会清除。","确定跑路","我点错了",(e,t)=>{var o=i?.Chest;null!=t&&null!=o&&(1==t?RemoveShop(o.pos)&&e.tell("删除成功"):e.tell("已取消"))})}}AddItemForm(){let e=mc.newCustomForm(),a=this.Chest.getContainer(),t=this.Player.getHand();if(!t.isNull()){e=e.setTitle("§l上架商品"),e=e.addLabel(Format.Gray+"=================§r§l上架手中的物品§r"+Format.Gray+"================"),e=e.addLabel("物品名称： "+t.name+"\n物品数量： "+t.count+"\n物品数据： "+t.getNbt().toString()),e=e.addInput("商品显示名称：","购买页面显示的名称",t.name),e=e.addInput("商品价格：","输入商品价格");let o=new Array,i={};for(let t=0;t<a.size;t++){let e=a.getItem(t);var s;e.isNull()&&(s=o.push("格子"+(t+1)),i[s-1]=t)}return e=e.addDropdown("选择一个空的格子",o),ShopBackstageManagementForm.FormData.set(this.Player.xuid,i),e}}static AddItem(i,t){let a=ShopBackstageManagementForm.Instances.get(i.xuid);if(null!=a&&null!=t){let o=i.getHand();var s=ShopBackstageManagementForm.FormData.get(i.xuid)[Number(t[4])],r=t[2],n=Number(t[3]);let e=o.getNbt();var l=e.toSNBT();if(null==t[3]||n<=0||!Number.isInteger(n))i.sendModalForm("错误","价格不能留空，且只允许大于零的整数","确定","取消",(e,t)=>{});else{l=new Commodity(r,s,n,e,l);let t=a.Chest.getContainer();if(t.hasRoomFor(o)){let e=t.getItem(s);e.set(o)?(a.Shop.Goods.push(l),o.setNull(),i.refreshItems(),i.sendModalForm("成功","商品添加成功！","返回","取消",(e,t)=>{null!=t&&1==t&&a?.Display()}),DataHelper.SaveData()):i.sendModalForm("错误","商品添加失败！\n未知原因","返回","取消",(e,t)=>{null!=t&&1==t&&a?.Display()})}else i.sendModalForm("错误","商品添加失败！\n当前箱子没有足够的空间","确定","取消",(e,t)=>{null!=t&&1==t&&a?.Display()})}}}Display(){this.Player.sendForm(this.MainForm(),ShopBackstageManagementForm.Main)}}ShopBackstageManagementForm.Instances=new Map,ShopBackstageManagementForm.FormData=new Map;